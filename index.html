<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ASI Multiservices — Gestione Mappe PDR</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { background: #f1f5f9; }
    .card { transition: box-shadow .2s, transform .2s; }
    .card:hover { box-shadow: 0 8px 24px rgba(0,0,0,.12); transform: translateY(-2px); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 1000; display: flex; align-items: center; justify-content: center; }
</style>
</head>
<body class="min-h-screen">

<header class="bg-slate-800 text-white px-6 py-4 shadow-lg flex items-center justify-between">
    <div class="flex items-center gap-3">
        <i class="fa-solid fa-map-location-dot text-2xl text-blue-400"></i>
        <div>
            <h1 class="text-xl font-bold leading-tight">ASI Multiservices</h1>
            <p class="text-xs text-slate-400">Gestione Mappe PDR</p>
        </div>
    </div>
    <button onclick="openNewMapModal()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold px-4 py-2 rounded-lg transition">
        <i class="fa-solid fa-plus"></i> Nuova Mappa
    </button>
</header>

<main class="max-w-4xl mx-auto px-4 py-8">
    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Mappe Disponibili</h2>
    <div id="mapList" class="grid gap-4 sm:grid-cols-2"></div>
</main>

<div id="newMapModal" class="modal-overlay hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6">
        <div class="flex justify-between items-center mb-5">
            <h2 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-plus-circle mr-2 text-blue-500"></i>Nuova Mappa Letture</h2>
            <button onclick="closeNewMapModal()" class="text-slate-400 hover:text-slate-700 text-xl">&times;</button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Nome visualizzato *</label>
                <input id="newMapLabel" type="text" placeholder="Es. Marzo 2026" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Nome collection Firestore *</label>
                <input id="newMapCollection" type="text" placeholder="Es. letture_massive_marzo" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-400">
                <p class="text-[10px] text-slate-400 mt-1">Solo lettere minuscole, numeri e trattini bassi.</p>
            </div>
        </div>
        <div id="newMapError" class="hidden mt-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg px-3 py-2"></div>
        <div class="flex gap-3 mt-6">
            <button onclick="closeNewMapModal()" class="flex-1 py-2 text-sm text-slate-600 border border-slate-300 rounded-lg hover:bg-slate-50 transition">Annulla</button>
            <button onclick="generateAndDownload()" class="flex-1 py-2 text-sm font-bold bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-download"></i> Genera e Scarica
            </button>
        </div>
        <p class="text-[10px] text-slate-400 text-center mt-3">Salva il file nella cartella del progetto e fai git push per renderlo disponibile online.</p>
    </div>
</div>

<script>
const EXISTING_MAPS = [
    { label:"Letture Massive — Febbraio 2026", file:"Mappa_Letture_Massive_Febbraio.html", collection:"letture_massive_febbraio", icon:"fa-calendar", color:"blue", desc:"Giro letture mensile feb 2026" },
    { label:"Letture Massive — Gennaio 2026",  file:"Mappa_Letture_Massive_Gennaio.html",  collection:"letture_pdr_riepilogo",    icon:"fa-calendar", color:"indigo", desc:"Giro letture mensile gen 2026" },
    { label:"Sostituzione Contatori",          file:"Sostituzione_contatori.html",          collection:"sostituzione_contatori",   icon:"fa-wrench",   color:"orange", desc:"Interventi sostituzione contatori" },
    { label:"Mappa Riduttori",                 file:"Mappa_riduttori_V1.html",              collection:"riduttori",                icon:"fa-sliders",  color:"green", desc:"Mappa riduttori di pressione" }
];
const CLR = { blue:{bg:"bg-blue-50",border:"border-blue-200",badge:"bg-blue-100 text-blue-700",icon:"text-blue-500"}, indigo:{bg:"bg-indigo-50",border:"border-indigo-200",badge:"bg-indigo-100 text-indigo-700",icon:"text-indigo-500"}, orange:{bg:"bg-orange-50",border:"border-orange-200",badge:"bg-orange-100 text-orange-700",icon:"text-orange-500"}, green:{bg:"bg-green-50",border:"border-green-200",badge:"bg-green-100 text-green-700",icon:"text-green-600"} };

function renderMapList() {
    const el = document.getElementById('mapList'); el.innerHTML = '';
    EXISTING_MAPS.forEach(m => {
        const c = CLR[m.color]||CLR.blue;
        const a = document.createElement('a'); a.href = m.file;
        a.className = `card block ${c.bg} border ${c.border} rounded-2xl p-5 no-underline`;
        a.innerHTML = `<div class="flex items-start justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-white shadow flex items-center justify-center"><i class="fa-solid ${m.icon} ${c.icon} text-lg"></i></div><div><div class="font-bold text-slate-800 text-sm leading-tight">${m.label}</div><div class="text-xs text-slate-500 mt-0.5">${m.desc}</div></div></div><i class="fa-solid fa-chevron-right text-slate-300 mt-1"></i></div><div class="mt-3"><span class="text-[10px] font-mono ${c.badge} px-2 py-0.5 rounded">${m.collection}</span></div>`;
        el.appendChild(a);
    });
}

function openNewMapModal()  { document.getElementById('newMapModal').classList.remove('hidden'); document.getElementById('newMapLabel').focus(); }
function closeNewMapModal() { document.getElementById('newMapModal').classList.add('hidden'); clearError(); }
function clearError() { const e = document.getElementById('newMapError'); e.classList.add('hidden'); e.textContent=''; }
function showError(msg) { const e = document.getElementById('newMapError'); e.textContent=msg; e.classList.remove('hidden'); }

function generateAndDownload() {
    clearError();
    const label = document.getElementById('newMapLabel').value.trim();
    const coll  = document.getElementById('newMapCollection').value.trim();
    if (!label) { showError("Inserisci un nome visualizzato."); return; }
    if (!coll)  { showError("Inserisci il nome collection Firestore."); return; }
    if (!/^[a-z0-9_]+$/.test(coll)) { showError("Solo lettere minuscole, numeri e _ (no spazi)."); return; }
    fetch('Mappa_Letture_Massive_Febbraio.html')
        .then(r => { if (!r.ok) throw new Error('Template non trovato'); return r.text(); })
        .then(html => {
            html = html.replace(/COLLECTION_NAME: 'letture_massive_febbraio'/, `COLLECTION_NAME: '${coll}'`);
            html = html.replace(/<title>.*?<\/title>/, `<title>Mappa PDR ${label} - ASI Multiservices</title>`);
            const filename = `Mappa_${coll}.html`;
            const blob = new Blob([html], {type:'text/html;charset=utf-8'});
            const url  = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download=filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            EXISTING_MAPS.push({label,file:filename,collection:coll,icon:'fa-calendar',color:'blue',desc:'Generata il '+new Date().toLocaleDateString('it-IT')});
            renderMapList(); closeNewMapModal();
            setTimeout(()=>alert(`File "${filename}" scaricato!\n\nPer renderla permanente:\n1. Metti il file nella cartella del progetto\n2. Aggiungi la voce in EXISTING_MAPS dentro index.html\n3. git add + commit + push`),200);
        })
        .catch(e => showError(`Errore: ${e.message}. Serve un server HTTP (non file://).`));
}

renderMapList();
</script>
</body>
</html>
